# Mobile App — Flutter + Rust FFI

Remote terminal client for Android/iOS. Connects to the Okena desktop server via REST + WebSocket. Uses `alacritty_terminal` in Rust for ANSI processing — identical terminal emulation as the desktop app.

## Build Commands

```bash
# Rust crate only
cargo build -p okena_mobile_native
cargo test -p okena_mobile_native

# Regenerate Dart FFI bindings (after changing Rust api/ signatures)
cd mobile && flutter_rust_bridge_codegen generate

# Build APK
export ANDROID_HOME=~/android-sdk
export PATH="$HOME/flutter/bin:$HOME/.cargo/bin:$PATH"
cd mobile && flutter build apk --debug
```

**Critical:**
- `run_build_tool.sh` needs `$HOME/.cargo/bin` in PATH (Gradle daemon doesn't inherit it)
- Use `rustls-tls` (not `native-tls`) for all deps — avoids cross-compiling OpenSSL for NDK

## Architecture

```
┌──────────────────────────────────────────────────────────────┐
│  Flutter Mobile App                                          │
│                                                              │
│  ┌──────────────────┐    ┌────────────────────────────────┐  │
│  │ Dart UI           │    │ Rust (via flutter_rust_bridge)  │  │
│  │                   │    │                                 │  │
│  │ Screens           │    │ ConnectionManager (OnceLock)    │  │
│  │ Providers         │    │  ├─ RemoteClient<Handler>       │  │
│  │ Widgets           │    │  ├─ MobileConnectionHandler     │  │
│  │                   │    │  └─ TerminalHolder per terminal │  │
│  │                   │    │     └─ alacritty_terminal::Term │  │
│  └──────────────────┘    └────────────────────────────────┘  │
│          │                          │                         │
│     flutter_rust_bridge (FFI)       │                         │
└──────────┼──────────────────────────┼─────────────────────────┘
           │           HTTP + WebSocket
           ▼                          ▼
┌──────────────────────────────────────────────────────────────┐
│  Okena Desktop (remote server on src/remote/)                │
│  POST /v1/pair, GET /v1/state, POST /v1/actions, WS /v1/stream │
└──────────────────────────────────────────────────────────────┘
```

## Directory Structure

```
mobile/
├── lib/
│   ├── main.dart                     # App entry, MultiProvider setup, AppRouter
│   └── src/
│       ├── models/
│       │   ├── layout_node.dart      # Sealed classes: TerminalNode, SplitNode, TabsNode
│       │   └── saved_server.dart     # Server config (host, port, label), JSON persistence
│       ├── providers/
│       │   ├── connection_provider.dart  # Saved servers, connection lifecycle, status polling
│       │   └── workspace_provider.dart   # Project list, focused project, 1s polling
│       ├── screens/
│       │   ├── server_list_screen.dart   # Server list + add bottom sheet
│       │   ├── pairing_screen.dart       # Connect → pair flow, code input
│       │   └── workspace_screen.dart     # App bar + drawer + layout + key toolbar
│       ├── theme/
│       │   └── app_theme.dart        # JetBrainsMono font, Catppuccin dark colors
│       ├── widgets/
│       │   ├── key_toolbar.dart      # ESC, TAB, CTRL/ALT (sticky), arrows
│       │   ├── layout_renderer.dart  # Recursive layout tree → TerminalView/Flex/Tabs
│       │   ├── project_drawer.dart   # Project list drawer with disconnect button
│       │   ├── status_indicator.dart # Colored dot + label
│       │   ├── terminal_painter.dart # CustomPainter: bg rects → text → cursor
│       │   └── terminal_view.dart    # Terminal widget: resize, input, 30fps polling
│       └── rust/                     # GENERATED by flutter_rust_bridge — do not edit
│           └── api/                  # Dart bindings for native/src/api/
├── native/                           # Rust FFI crate (okena_mobile_native)
│   └── src/
│       ├── lib.rs
│       ├── api/
│       │   ├── connection.rs         # init_app, connect, pair, disconnect, connection_status
│       │   ├── terminal.rs           # get_visible_cells, get_cursor, send_text, resize_terminal
│       │   └── state.rs              # get_projects, is_dirty, send_special_key, get_project_layout_json
│       ├── client/
│       │   ├── manager.rs            # ConnectionManager singleton (OnceLock + 2-thread tokio runtime)
│       │   ├── handler.rs            # MobileConnectionHandler (impl ConnectionHandler)
│       │   └── terminal_holder.rs    # alacritty_terminal::Term wrapper + dirty flag
│       └── frb_generated.rs          # GENERATED — do not edit
├── fonts/                            # JetBrainsMono (Regular, Bold, Italic, BoldItalic)
├── rust_builder/                     # Cargokit — NDK cross-compilation tooling
├── flutter_rust_bridge.yaml          # FRB config: rust_root=native/, dart_output=lib/src/rust
└── pubspec.yaml                      # Flutter deps: provider, shared_preferences, flutter_rust_bridge
```

## Data Flow

### Terminal output (server → screen)

```
Remote PTY → WS binary frame → RemoteClient → MobileConnectionHandler.on_terminal_output()
  → TerminalHolder.process_output() (alacritty ANSI parse) → dirty flag
  → Flutter polls is_dirty() every 33ms → get_visible_cells() → CustomPainter repaint
```

### Keyboard input (user → server)

```
Soft keyboard / KeyToolbar tap → FFI send_text() or send_special_key()
  → ConnectionManager.send_ws_message() → WS → Server → PTY stdin
```

### State sync

```
WS "state_changed" event → RemoteClient fetches GET /v1/state
  → diff_states() → create/remove TerminalHolders → state_cache updated
  → Flutter polls get_projects() every 1s → UI update
```

## Key Patterns

### State management
- `ChangeNotifier` providers with polling (no push from Rust → Dart)
- `ConnectionProvider`: 500ms fast poll during connect/pair, 2s when connected
- `WorkspaceProvider`: 1s poll for project list, auto-selects focused project

### Terminal rendering
- `TerminalPainter` (CustomPainter): 3-pass — background rects, text, cursor
- `TerminalView`: `LayoutBuilder` measures size → computes cols/rows → `resize_terminal()` FFI
- 33ms refresh timer (~30fps) via `is_dirty()` check
- 200ms debounce on resize

### Layout rendering
- `LayoutRenderer` parses `get_project_layout_json()` into sealed `LayoutNode` classes
- Recursive rendering: `TerminalNode` → `TerminalView`, `SplitNode` → `Flex`, `TabsNode` → tab bar
- Auto-converts horizontal splits to vertical in portrait orientation

### Key toolbar
- CTRL/ALT are sticky toggles (tap to activate, next key applies modifier, auto-resets)
- CTRL+key sends control character directly (e.g., CTRL+C → `\x03`)

### Rust singleton
- `ConnectionManager` is `OnceLock<ConnectionManager>` — no GPUI entity system on mobile
- 2-thread tokio runtime for async networking
- All FFI functions access via `ConnectionManager::get()`
- `NoopEventListener` on `Term` — prevents duplicate PtyWrite responses (server already handles them)

## FFI Surface (native/src/api/)

### connection.rs
| Function | Description |
|----------|-------------|
| `init_app()` | Setup FRB + ConnectionManager |
| `connect(host, port) → String` | Create connection, return conn_id |
| `pair(conn_id, code)` | Async pair + start WS |
| `disconnect(conn_id)` | Close WS, cleanup |
| `connection_status(conn_id) → ConnectionStatus` | Current status |

### terminal.rs
| Function | Description |
|----------|-------------|
| `get_visible_cells(conn_id, terminal_id) → Vec<CellData>` | Grid cells with ARGB + flags |
| `get_cursor(conn_id, terminal_id) → CursorState` | Position, shape, visibility |
| `send_text(conn_id, terminal_id, text)` | Send text via WS (async) |
| `resize_terminal(conn_id, terminal_id, cols, rows)` | Resize local + send WS (async) |

### state.rs
| Function | Description |
|----------|-------------|
| `get_projects(conn_id) → Vec<ProjectInfo>` | Project list from cache |
| `get_focused_project_id(conn_id) → Option<String>` | Server's focused project |
| `is_dirty(conn_id, terminal_id) → bool` | Has new output since last read |
| `send_special_key(conn_id, terminal_id, key)` | Named key (async) |
| `get_project_layout_json(conn_id, project_id) → Option<String>` | Layout tree as JSON |
| `get_all_terminal_ids(conn_id) → Vec<String>` | All terminal IDs |

## Dependencies

- **flutter_rust_bridge 2.11.1** — Rust↔Dart FFI bridge + codegen
- **provider** — State management (ChangeNotifier)
- **shared_preferences** — Persist saved server list
- **okena-core** (workspace crate) — Shared types, RemoteClient, ThemeColors
- **alacritty_terminal** — Terminal emulation (same as desktop)
- **tokio** + **tokio-tungstenite** (rustls-tls) — Async runtime + WebSocket
- **reqwest** (rustls-tls) — HTTP client for REST API
